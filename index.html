<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire TV Signage Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        
        .player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 999999;
        }
        
        .loading-screen, .error-screen {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #fff;
            text-align: center;
            padding: 40px;
        }
        
        .loading-icon {
            font-size: 48px;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .content-frame {
            width: 100%;
            height: 100%;
        }
        
        .content-frame iframe,
        .content-frame img,
        .content-frame video {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
        }
        
        .debug-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-family: monospace;
            max-width: 400px;
            z-index: 1000000;
        }
        
        .debug-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .debug-info {
            font-size: 9px;
            color: #888;
        }
        
        .message-container {
            width: 100%;
            height: 100%;
            display: grid;
            position: relative;
        }
        
        .message-zone {
            overflow: hidden;
            box-sizing: border-box;
        }
        
        .message-zone-text {
            word-wrap: break-word;
            white-space: pre-wrap;
            width: 100%;
            height: 100%;
        }
        
        .datetime-widget {
            position: absolute;
            background: #000;
            color: white;
            border-radius: 8px;
            font-weight: 300;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app" class="player-container"></div>
    
    <script>
        const BACKEND_URL = "https://artform-signage-app.onrender.com";
        const DEVICE_ID = "firetv_001";
        const SCREEN_WIDTH_INCHES = 52.3;
        const SCREEN_HEIGHT_INCHES = 29.4;
        
        let state = {
            status: 'initializing',
            error: null,
            playlist: null,
            currentIndex: 0,
            content: null,
            previewScale: 1,
            debugLog: [],
            scrollInterval: null
        };
        
        function log(msg) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${msg}`);
            state.debugLog.push(`[${timestamp}] ${msg}`);
            if (state.debugLog.length > 30) state.debugLog.shift();
        }
        
        function calculateScale() {
            const viewportWidth = window.innerWidth;
            state.previewScale = viewportWidth / SCREEN_WIDTH_INCHES;
        }
        
        function inchesToPx(inches) {
            return inches * state.previewScale;
        }
        
        function getGridTemplate(layout) {
            const templates = {
                "full": "1fr / 1fr",
                "split-vertical": "1fr / 1fr 1fr",
                "split-horizontal": "1fr 1fr / 1fr",
                "three-column": "1fr / 1fr 1fr 1fr",
                "three-row": "1fr 1fr 1fr / 1fr",
                "grid-2x2": "1fr 1fr / 1fr 1fr",
                "grid-3x3": "1fr 1fr 1fr / 1fr 1fr 1fr",
                "grid-4x4": "1fr 1fr 1fr 1fr / 1fr 1fr 1fr 1fr"
            };
            return templates[layout] || "1fr / 1fr";
        }
        
        function getZoneGridArea(layout, zoneId) {
            const layouts = {
                "full": { main: "1/1/2/2" },
                "split-vertical": { left: "1/1/2/2", right: "1/2/2/3" },
                "split-horizontal": { top: "1/1/2/2", bottom: "2/1/3/2" },
                "three-column": { left: "1/1/2/2", center: "1/2/2/3", right: "1/3/2/4" },
                "three-row": { top: "1/1/2/2", middle: "2/1/3/2", bottom: "3/1/4/2" },
                "grid-2x2": {
                    "top-left": "1/1/2/2",
                    "top-right": "1/2/2/3",
                    "bottom-left": "2/1/3/2",
                    "bottom-right": "2/2/3/3"
                },
                "grid-3x3": {
                    "row1-col1": "1/1/2/2", "row1-col2": "1/2/2/3", "row1-col3": "1/3/2/4",
                    "row2-col1": "2/1/3/2", "row2-col2": "2/2/3/3", "row2-col3": "2/3/3/4",
                    "row3-col1": "3/1/4/2", "row3-col2": "3/2/4/3", "row3-col3": "3/3/4/4"
                },
                "grid-4x4": {
                    r1c1: "1/1/2/2", r1c2: "1/2/2/3", r1c3: "1/3/2/4", r1c4: "1/4/2/5",
                    r2c1: "2/1/3/2", r2c2: "2/2/3/3", r2c3: "2/3/3/4", r2c4: "2/4/3/5",
                    r3c1: "3/1/4/2", r3c2: "3/2/4/3", r3c3: "3/3/4/4", r3c4: "3/4/4/5",
                    r4c1: "4/1/5/2", r4c2: "4/2/5/3", r4c3: "4/3/5/4", r4c4: "4/4/5/5"
                }
            };
            return layouts[layout]?.[zoneId] || "1/1/2/2";
        }
        
        function renderLoading() {
            return `
                <div class="loading-screen">
                    <div class="loading-icon">üîÑ</div>
                    <div style="font-size: 24px; margin-bottom: 10px;">Loading Fire TV Signage...</div>
                    <div style="font-size: 14px; color: #888;">Device: ${DEVICE_ID}</div>
                </div>
            `;
        }
        
        function renderError() {
            return `
                <div class="error-screen">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div style="font-size: 28px; margin-bottom: 15px;">Backend Error</div>
                    <div style="font-size: 16px; color: #aaa; max-width: 800px; line-height: 1.6; margin-bottom: 20px;">
                        ${state.error || 'Unable to load content'}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 20px;">
                        Device ID: ${DEVICE_ID} | Backend: ${BACKEND_URL}
                    </div>
                </div>
            `;
        }
        
        function renderMessage(content) {
            const message = content.message || {};
            const layout = message.layout || "full";
            const zones = message.zones || [];
            const background = message.background || "#ffffff";
            const showDateTime = message.showDateTime || false;
            
            let zonesHtml = zones.map(zone => {
                const fontSize = parseFloat(zone.fontSizeInches) || 0.25;
                const padding = parseFloat(zone.paddingInches) || 0.5;
                const textAlign = zone.textAlign || 'left';
                
                return `
                    <div class="message-zone" style="
                        grid-area: ${getZoneGridArea(layout, zone.id)};
                        background-color: ${zone.backgroundColor || 'transparent'};
                        color: ${zone.textColor || '#000000'};
                        padding: ${inchesToPx(padding)}px;
                    ">
                        <div class="message-zone-text" style="
                            font-size: ${inchesToPx(fontSize)}px;
                            font-weight: ${zone.fontWeight || '400'};
                            text-align: ${textAlign};
                            line-height: 1.2;
                        ">
                            ${zone.text || ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            let dateTimeHtml = '';
            if (showDateTime) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                dateTimeHtml = `
                    <div class="datetime-widget" style="
                        bottom: ${inchesToPx(1)}px;
                        right: ${inchesToPx(1)}px;
                        width: ${inchesToPx(5)}px;
                        padding: ${inchesToPx(0.4)}px ${inchesToPx(0.6)}px;
                    ">
                        <div style="font-size: ${inchesToPx(0.35)}px; line-height: 1.3;">${dateStr}</div>
                        <div style="font-size: ${inchesToPx(0.45)}px; font-weight: 400; margin-top: ${inchesToPx(0.05)}px; line-height: 1.3;">${timeStr}</div>
                    </div>
                `;
            }
            
            return `
                <div class="message-container" style="
                    background-color: ${layout === 'full' ? background : '#ffffff'};
                    grid-template: ${getGridTemplate(layout)};
                ">
                    ${zonesHtml}
                    ${dateTimeHtml}
                </div>
            `;
        }
        
        function setupAutoScroll() {
            if (state.content?.type === 'url' && state.content?.autoScroll) {
                log("Setting up auto-scroll for URL content");
                
                setTimeout(() => {
                    const iframe = document.querySelector('iframe');
                    if (iframe) {
                        iframe.onload = function() {
                            try {
                                const iframeWin = iframe.contentWindow;
                                let scrollPos = 0;
                                
                                state.scrollInterval = setInterval(() => {
                                    scrollPos += 1;
                                    const maxScroll = iframeWin.document.body.scrollHeight - iframe.clientHeight;
                                    
                                    if (scrollPos >= maxScroll) {
                                        scrollPos = 0;
                                    }
                                    
                                    iframeWin.scrollTo(0, scrollPos);
                                }, 50);
                            } catch (e) {
                                log(`Cannot auto-scroll iframe (CORS): ${e.message}`);
                            }
                        };
                    }
                }, 100);
            }
        }
        
        function clearAutoScroll() {
            if (state.scrollInterval) {
                clearInterval(state.scrollInterval);
                state.scrollInterval = null;
            }
        }
        
        function renderContent(content) {
            if (!content) return '';
            
            clearAutoScroll();
            
            switch (content.type) {
                case 'image':
                    return `<div class="content-frame"><img src="${content.url}" alt="${content.title}"></div>`;
                
                case 'video':
                    return `<div class="content-frame"><video src="${content.url}" autoplay muted loop></video></div>`;
                
                case 'youtube':
                    const videoId = content.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
                    return `<div class="content-frame"><iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&loop=1" allow="autoplay"></iframe></div>`;
                
                case 'url':
                    setTimeout(() => setupAutoScroll(), 100);
                    return `<div class="content-frame"><iframe src="${content.url}"></iframe></div>`;
                
                case 'message':
                    return renderMessage(content);
                
                default:
                    return `<div class="error-screen"><div style="font-size: 24px;">Unsupported content type: ${content.type}</div></div>`;
            }
        }
        
        function renderDebug() {
            if (!state.content) return '';
            
            return `
                <div class="debug-overlay">
                    <div class="debug-title">
                        ${state.content.title || 'Playing'} | ${state.currentIndex + 1}/${state.playlist?.items?.length || 0}
                    </div>
                    <div class="debug-info">
                        Type: ${state.content.type || 'undefined'} | Duration: ${state.content.duration || state.playlist?.default_duration || 'N/A'}s
                        ${state.content.autoScroll ? ' | Auto-Scroll: ON' : ''}
                    </div>
                </div>
            `;
        }
        
        function render() {
            const app = document.getElementById('app');
            
            let html = '';
            if (state.status === 'initializing' || state.status === 'loading') {
                html = renderLoading();
            } else if (state.status === 'error') {
                html = renderError();
            } else if (state.status === 'playing' && state.content) {
                html = renderContent(state.content) + renderDebug();
            }
            
            app.innerHTML = html;
            
            if (state.status === 'playing' && state.content?.type === 'message' && state.content?.message?.showDateTime) {
                setTimeout(() => {
                    if (state.status === 'playing' && state.content?.type === 'message') {
                        render();
                    }
                }, 1000);
            }
        }
        
        function scheduleNextContent() {
            if (!state.playlist || !state.content) return;
            
            const duration = (state.content.duration || state.playlist.default_duration || 15) * 1000;
            log(`Showing "${state.content.title}" for ${duration/1000}s`);
            
            setTimeout(() => {
                if (state.playlist.items && state.playlist.items.length > 1) {
                    state.currentIndex = (state.currentIndex + 1) % state.playlist.items.length;
                    state.content = state.playlist.items[state.currentIndex];
                    log(`Switching to item ${state.currentIndex + 1}/${state.playlist.items.length}`);
                    render();
                    scheduleNextContent();
                } else {
                    scheduleNextContent();
                }
            }, duration);
        }
        
        async function fetchSchedule() {
            try {
                log(`Fetching schedule for device: ${DEVICE_ID}`);
                const response = await fetch(`${BACKEND_URL}/v1/device/schedule?device_id=${DEVICE_ID}`);
                const data = await response.json();
                
                if (!data.ok || !data.schedules || data.schedules.length === 0) {
                    throw new Error("No active schedule found for this device");
                }
                
                const schedule = data.schedules[0];
                log(`Active schedule: ${schedule.name || 'unnamed'}`);
                
                if (!schedule.mediaId) {
                    throw new Error("Schedule has no playlist assigned");
                }
                
                log(`Fetching playlist: ${schedule.mediaId}`);
                const playlistRes = await fetch(`${BACKEND_URL}/v1/media/${schedule.mediaId}`);
                const playlistData = await playlistRes.json();
                
                if (!playlistData.ok || !playlistData.playlist) {
                    throw new Error("Failed to load playlist");
                }
                
                const playlist = playlistData.playlist;
                log(`Loaded playlist: ${playlist.name} (${playlist.items?.length || 0} items)`);
                
                if (!playlist.items || playlist.items.length === 0) {
                    throw new Error("Playlist is empty");
                }
                
                const firstItem = playlist.items[0];
                if (!firstItem.type) {
                    throw new Error("Backend error: Playlist items missing 'type' field");
                }
                
                log(`Rendering: ${firstItem.title} (${firstItem.type})`);
                
                state.playlist = playlist;
                state.content = firstItem;
                state.currentIndex = 0;
                state.status = 'playing';
                
                render();
                scheduleNextContent();
                
            } catch (err) {
                log(`ERROR: ${err.message}`);
                state.error = err.message;
                state.status = 'error';
                render();
            }
        }
        
        function init() {
            log("Fire TV Player initializing...");
            calculateScale();
            window.addEventListener('resize', () => {
                calculateScale();
                if (state.status === 'playing') render();
            });
            
            state.status = 'loading';
            render();
            
            fetchSchedule();
            
            setInterval(fetchSchedule, 5 * 60 * 1000);
        }
        
        init();
    </script>
</body>
</html>
