<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtformTV Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body, html {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        #player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #content-display {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #content-display img,
        #content-display video,
        #content-display iframe {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: none;
        }
        #logo {
            position: absolute;
            bottom: calc(1 / 52.3 * 100vw);
            left: calc(1 / 52.3 * 100vw);
            height: calc(1.2 / 52.3 * 100vw);
            z-index: 1000;
        }
        #logo img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }
        #datetime {
            position: absolute;
            bottom: calc(1 / 52.3 * 100vw);
            right: calc(1 / 52.3 * 100vw);
            width: calc(5 / 52.3 * 100vw);
            padding: calc(0.4 / 52.3 * 100vw) calc(0.6 / 52.3 * 100vw);
            background-color: #000000;
            color: white;
            border-radius: calc(0.3 / 52.3 * 100vw);
            font-weight: 300;
            text-align: center;
            z-index: 1000;
        }
        #datetime .date {
            font-size: calc(0.35 / 52.3 * 100vw);
            line-height: 1.3;
        }
        #datetime .time {
            font-size: calc(0.45 / 52.3 * 100vw);
            font-weight: 400;
            margin-top: calc(0.05 / 52.3 * 100vw);
            line-height: 1.3;
        }
        .loading, .error {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #fff;
            text-align: center;
            padding: 40px;
        }
        .loading .icon { font-size: 48px; margin-bottom: 20px; }
        .loading .message { font-size: 24px; }
        .loading .device { font-size: 14px; color: #888; margin-top: 10px; }
        .error .icon { font-size: 64px; margin-bottom: 20px; }
        .error .title { font-size: 28px; margin-bottom: 15px; }
        .error .message { font-size: 16px; color: #aaa; max-width: 800px; line-height: 1.6; }
        .error .device { font-size: 12px; color: #666; margin-top: 30px; }
    </style>
</head>
<body>
    <div id="player-container">
        <div id="content-display"></div>
        
        <!-- ArtformTV Logo - Bottom Left -->
        <div id="logo">
            <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6908b5a4fa4cc7ec770d76c7/4a3b22c98_Artform_TV.png" alt="ArtformTV">
        </div>
        
        <!-- Date & Time - Bottom Right -->
        <div id="datetime">
            <div class="date"></div>
            <div class="time"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = "https://artform-signage-app.onrender.com";
        const SCREEN_WIDTH_INCHES = 52.3;
        
        // Get device_id from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('device_id') || 'firetv_001';
        
        let currentPlaylist = null;
        let currentIndex = 0;
        let contentTimer = null;
        let scrollInterval = null;

        console.log('[Player] Device ID:', deviceId);

        // Update date/time display
        function updateDateTime() {
            const now = new Date();
            const dateEl = document.querySelector('#datetime .date');
            const timeEl = document.querySelector('#datetime .time');
            
            dateEl.textContent = now.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            timeEl.textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Show loading state
        function showLoading() {
            document.getElementById('content-display').innerHTML = `
                <div class="loading">
                    <div class="icon">üîÑ</div>
                    <div class="message">Loading ArtformTV Player...</div>
                    <div class="device">Device: ${deviceId}</div>
                </div>
            `;
        }

        // Show error state
        function showError(message) {
            document.getElementById('content-display').innerHTML = `
                <div class="error">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="title">Backend Error</div>
                    <div class="message">${message}</div>
                    <div class="device">Device ID: ${deviceId} | Backend: ${BACKEND_URL}</div>
                </div>
            `;
        }

        // Render content based on type
        function renderContent(content) {
            const display = document.getElementById('content-display');
            
            // Clear any existing scroll interval
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
            
            switch (content.type) {
                case 'image':
                    display.innerHTML = `<img src="${content.url}" alt="${content.title}">`;
                    break;
                
                case 'video':
                    display.innerHTML = `<video src="${content.url}" autoplay muted loop></video>`;
                    break;
                
                case 'youtube':
                    const videoId = content.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
                    display.innerHTML = `
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&loop=1"
                            allow="autoplay"
                        ></iframe>
                    `;
                    break;
                
                case 'url':
                    display.innerHTML = `
                        <iframe 
                            id="url-iframe"
                            src="${content.url}"
                            sandbox="allow-same-origin allow-scripts allow-forms"
                        ></iframe>
                    `;
                    
                    // Handle auto-scroll if enabled
                    if (content.autoScroll) {
                        const delays = [500, 1000, 2000, 3000, 5000];
                        delays.forEach(delay => {
                            setTimeout(() => {
                                try {
                                    const iframe = document.getElementById('url-iframe');
                                    const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                                    
                                    if (iframeDoc) {
                                        const script = iframeDoc.createElement('script');
                                        script.textContent = `
                                            (function() {
                                                var scrollPos = 0;
                                                var scrollInterval = setInterval(function() {
                                                    var maxScroll = Math.max(
                                                        document.body.scrollHeight,
                                                        document.documentElement.scrollHeight
                                                    ) - window.innerHeight;
                                                    
                                                    scrollPos += 1;
                                                    if (scrollPos >= maxScroll) {
                                                        scrollPos = 0;
                                                    }
                                                    
                                                    window.scrollTo(0, scrollPos);
                                                }, 50);
                                                
                                                window.addEventListener('unload', function() {
                                                    clearInterval(scrollInterval);
                                                });
                                            })();
                                        `;
                                        iframeDoc.body.appendChild(script);
                                        console.log('[Player] Auto-scroll injected at', delay, 'ms');
                                    }
                                } catch (e) {
                                    console.warn('[Player] Auto-scroll injection failed:', e.message);
                                }
                            }, delay);
                        });
                    }
                    break;
                
                case 'message':
                    const message = content.message || {};
                    const layout = message.layout || "full";
                    const zones = message.zones || [];
                    const background = message.background || "#ffffff";
                    
                    // Calculate grid template
                    let gridTemplate;
                    switch(layout) {
                        case "full": gridTemplate = "1fr / 1fr"; break;
                        case "split-vertical": gridTemplate = "1fr / 1fr 1fr"; break;
                        case "split-horizontal": gridTemplate = "1fr 1fr / 1fr"; break;
                        case "three-column": gridTemplate = "1fr / 1fr 1fr 1fr"; break;
                        case "three-row": gridTemplate = "1fr 1fr 1fr / 1fr"; break;
                        case "grid-2x2": gridTemplate = "1fr 1fr / 1fr 1fr"; break;
                        case "grid-3x3": gridTemplate = "1fr 1fr 1fr / 1fr 1fr 1fr"; break;
                        case "grid-4x4": gridTemplate = "1fr 1fr 1fr 1fr / 1fr 1fr 1fr 1fr"; break;
                        default: gridTemplate = "1fr / 1fr";
                    }
                    
                    let html = `
                        <div style="
                            width: 100%;
                            height: 100%;
                            background-color: ${layout === "full" ? background : "#ffffff"};
                            display: grid;
                            grid-template: ${gridTemplate};
                        ">
                    `;
                    
                    zones.forEach(zone => {
                        const fontSize = (zone.fontSizeInches || 0.25) / SCREEN_WIDTH_INCHES * 100;
                        const padding = (zone.paddingInches || 0.5) / SCREEN_WIDTH_INCHES * 100;
                        
                        html += `
                            <div style="
                                background-color: ${zone.backgroundColor || 'transparent'};
                                color: ${zone.textColor || '#000000'};
                                padding: ${padding}vw;
                                font-size: ${fontSize}vw;
                                font-weight: ${zone.fontWeight || '400'};
                                text-align: ${zone.textAlign || 'left'};
                                line-height: 1.2;
                                word-wrap: break-word;
                                white-space: pre-wrap;
                                overflow: hidden;
                            ">
                                ${zone.text || ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    display.innerHTML = html;
                    break;
                
                default:
                    display.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px;">
                            Content type "${content.type}" not yet supported
                        </div>
                    `;
            }
        }

        // Play content from playlist
        function playContent(index) {
            if (!currentPlaylist || !currentPlaylist.items || currentPlaylist.items.length === 0) {
                console.error('[Player] No playlist or empty playlist');
                return;
            }
            
            currentIndex = index % currentPlaylist.items.length;
            const content = currentPlaylist.items[currentIndex];
            
            console.log('[Player] Playing:', content.title, '(index', currentIndex, ')');
            renderContent(content);
            
            // Schedule next content
            const duration = (content.duration || currentPlaylist.default_duration || 15) * 1000;
            if (contentTimer) clearTimeout(contentTimer);
            
            contentTimer = setTimeout(() => {
                playContent(currentIndex + 1);
            }, duration);
        }

        // Fetch schedule and content from backend
        async function fetchSchedule() {
            try {
                console.log('[Player] Fetching schedule for device:', deviceId);
                const response = await fetch(`${BACKEND_URL}/v1/device/schedule?device_id=${deviceId}`);
                const data = await response.json();
                
                if (!data.ok || !data.schedules || data.schedules.length === 0) {
                    showError('No active schedule found for this device');
                    return;
                }
                
                const schedule = data.schedules[0];
                console.log('[Player] Active schedule:', schedule.name, 'mediaId:', schedule.mediaId);
                
                if (!schedule.mediaId) {
                    showError('Schedule has no playlist assigned');
                    return;
                }
                
                // Fetch playlist
                const playlistRes = await fetch(`${BACKEND_URL}/v1/media/${schedule.mediaId}`);
                const playlistData = await playlistRes.json();
                
                if (!playlistData.ok || !playlistData.playlist) {
                    showError('Failed to load playlist');
                    return;
                }
                
                currentPlaylist = playlistData.playlist;
                console.log('[Player] Loaded playlist:', currentPlaylist.name, 'with', currentPlaylist.items?.length || 0, 'items');
                
                if (!currentPlaylist.items || currentPlaylist.items.length === 0) {
                    showError('Playlist is empty');
                    return;
                }
                
                // Start playing
                playContent(0);
                
            } catch (error) {
                console.error('[Player] Error:', error);
                showError(`Connection error: ${error.message}`);
            }
        }

        // Initialize
        showLoading();
        fetchSchedule();
        
        // Refresh schedule every 5 minutes
        setInterval(fetchSchedule, 5 * 60 * 1000);
    </script>
</body>
</html>
