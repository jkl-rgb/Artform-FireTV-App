<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtformTV Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }

        .player-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        .content-display {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .content-display iframe,
        .content-display img,
        .content-display video {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
        }

        /* Logo - Bottom Left */
        .logo-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            height: 60px;
            z-index: 1000;
        }

        .logo-overlay img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }

        /* Date & Time - Bottom Right */
        .datetime-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #000;
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            text-align: center;
            font-weight: 300;
            z-index: 1000;
        }

        .datetime-overlay .date {
            font-size: 14px;
            line-height: 1.3;
        }

        .datetime-overlay .time {
            font-size: 18px;
            font-weight: 400;
            margin-top: 4px;
            line-height: 1.3;
        }

        /* Loading State */
        .loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100%;
            height: 100%;
            color: #fff;
        }

        .loading-screen .spinner {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .loading-screen .title {
            font-size: 24px;
        }

        .loading-screen .device-info {
            font-size: 14px;
            color: #888;
            margin-top: 10px;
        }

        /* Error State */
        .error-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100%;
            height: 100%;
            color: #fff;
            padding: 40px;
            text-align: center;
        }

        .error-screen .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-screen .title {
            font-size: 28px;
            margin-bottom: 15px;
        }

        .error-screen .message {
            font-size: 16px;
            color: #aaa;
            max-width: 800px;
            line-height: 1.6;
        }

        .error-screen .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 30px;
        }

        /* Debug Panel */
        .debug-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-family: monospace;
            max-width: 400px;
            z-index: 999;
        }

        .debug-panel .title {
            font-size: 12px;
            font-weight: bold;
        }

        .debug-panel .details {
            font-size: 9px;
            color: #888;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="player-container" id="playerContainer">
        <!-- Content will be dynamically inserted here -->
    </div>

    <!-- ArtformTV Logo - Always Visible -->
    <div class="logo-overlay">
        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6908b5a4fa4cc7ec770d76c7/97b153249_Artform_TV.png" alt="ArtformTV">
    </div>

    <!-- Date & Time - Always Visible -->
    <div class="datetime-overlay" id="dateTimeOverlay">
        <div class="date" id="dateDisplay"></div>
        <div class="time" id="timeDisplay"></div>
    </div>

    <!-- Debug Panel (Optional) -->
    <div class="debug-panel" id="debugPanel" style="display:none;">
        <div class="title" id="debugTitle"></div>
        <div class="details" id="debugDetails"></div>
    </div>

    <script>
        // Configuration
        const BACKEND_URL = "https://artform-signage-app.onrender.com";
        
        // Get device_id from URL parameter or use default
        function getDeviceId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('device_id') || 'firetv_001';
        }

        const DEVICE_ID = getDeviceId();

        // State
        let currentContent = null;
        let currentPlaylist = null;
        let currentIndex = 0;
        let contentTimer = null;

        // Initialize
        console.log(`[ArtformTV] Device ID: ${DEVICE_ID}`);
        console.log(`[ArtformTV] Backend: ${BACKEND_URL}`);

        // Update Date & Time
        function updateDateTime() {
            const now = new Date();
            const dateDisplay = document.getElementById('dateDisplay');
            const timeDisplay = document.getElementById('timeDisplay');
            
            if (dateDisplay && timeDisplay) {
                dateDisplay.textContent = now.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                timeDisplay.textContent = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        // Start date/time updater
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Show Loading State
        function showLoading() {
            const container = document.getElementById('playerContainer');
            container.innerHTML = `
                <div class="loading-screen">
                    <div class="spinner">üîÑ</div>
                    <div class="title">Loading ArtformTV Player...</div>
                    <div class="device-info">Device: ${DEVICE_ID}</div>
                </div>
            `;
        }

        // Show Error State
        function showError(message) {
            const container = document.getElementById('playerContainer');
            container.innerHTML = `
                <div class="error-screen">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="title">Connection Error</div>
                    <div class="message">${message}</div>
                    <div class="debug-info">Device: ${DEVICE_ID} | Backend: ${BACKEND_URL}</div>
                </div>
            `;
        }

        // Update Debug Panel
        function updateDebug(title, details) {
            const debugPanel = document.getElementById('debugPanel');
            const debugTitle = document.getElementById('debugTitle');
            const debugDetails = document.getElementById('debugDetails');
            
            if (debugPanel && debugTitle && debugDetails) {
                debugPanel.style.display = 'block';
                debugTitle.textContent = title;
                debugDetails.textContent = details;
            }
        }

        // Render Content
        function renderContent(content) {
            const container = document.getElementById('playerContainer');
            
            if (!content || !content.type) {
                showError('Invalid content data received');
                return;
            }

            console.log(`[ArtformTV] Rendering: ${content.title} (${content.type})`);
            
            updateDebug(
                `${content.title} | ${currentIndex + 1}/${currentPlaylist?.items?.length || 0}`,
                `Type: ${content.type} | Duration: ${content.duration || currentPlaylist?.default_duration || 'N/A'}s`
            );

            let contentHTML = '';

            switch (content.type) {
                case 'image':
                    contentHTML = `<div class="content-display"><img src="${content.url}" alt="${content.title}"></div>`;
                    break;

                case 'video':
                    contentHTML = `<div class="content-display"><video src="${content.url}" autoplay muted loop></video></div>`;
                    break;

                case 'youtube':
                    const videoId = content.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
                    if (videoId) {
                        contentHTML = `<div class="content-display"><iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&loop=1" allow="autoplay"></iframe></div>`;
                    }
                    break;

                case 'url':
                    contentHTML = `<div class="content-display"><iframe src="${content.url}" sandbox="allow-same-origin allow-scripts allow-forms"></iframe></div>`;
                    break;

                case 'message':
                    const message = content.message || {};
                    const zones = message.zones || [];
                    const background = message.background || '#ffffff';
                    
                    let zonesHTML = zones.map(zone => {
                        const fontSize = (zone.fontSizeInches || 0.25) * 96; // Convert inches to pixels (96 DPI)
                        const padding = (zone.paddingInches || 0.5) * 96;
                        
                        return `
                            <div style="
                                background-color: ${zone.backgroundColor || 'transparent'};
                                color: ${zone.textColor || '#000000'};
                                padding: ${padding}px;
                                font-size: ${fontSize}px;
                                font-weight: ${zone.fontWeight || '400'};
                                text-align: ${zone.textAlign || 'left'};
                                line-height: 1.2;
                                overflow: hidden;
                                display: flex;
                                align-items: center;
                                justify-content: ${zone.textAlign === 'center' ? 'center' : zone.textAlign === 'right' ? 'flex-end' : 'flex-start'};
                            ">
                                <span style="white-space: pre-wrap; word-wrap: break-word;">${zone.text || ''}</span>
                            </div>
                        `;
                    }).join('');
                    
                    contentHTML = `
                        <div class="content-display" style="background-color: ${background}; display: flex; flex-direction: column; justify-content: center; align-items: stretch;">
                            ${zonesHTML}
                        </div>
                    `;
                    break;

                default:
                    contentHTML = `<div class="content-display" style="display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;">Unsupported content type: ${content.type}</div>`;
            }

            container.innerHTML = contentHTML;

            // Setup auto-scroll for URLs if enabled
            if (content.type === 'url' && content.autoScroll) {
                setupAutoScroll();
            }
        }

        // Setup Auto-Scroll for URL content
        function setupAutoScroll() {
            setTimeout(() => {
                const iframe = document.querySelector('iframe');
                if (iframe) {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const script = iframeDoc.createElement('script');
                        script.textContent = `
                            (function() {
                                var scrollPos = 0;
                                var scrollInterval = setInterval(function() {
                                    var maxScroll = Math.max(
                                        document.body.scrollHeight,
                                        document.documentElement.scrollHeight
                                    ) - window.innerHeight;
                                    
                                    scrollPos += 1;
                                    if (scrollPos >= maxScroll) {
                                        scrollPos = 0;
                                    }
                                    
                                    window.scrollTo(0, scrollPos);
                                }, 50);
                            })();
                        `;
                        iframeDoc.body.appendChild(script);
                        console.log('[ArtformTV] Auto-scroll enabled');
                    } catch (e) {
                        console.log('[ArtformTV] Auto-scroll blocked by CORS');
                    }
                }
            }, 2000);
        }

        // Schedule Next Content Item
        function scheduleNextContent() {
            if (contentTimer) {
                clearTimeout(contentTimer);
            }

            if (!currentContent || !currentPlaylist) return;

            const duration = (currentContent.duration || currentPlaylist.default_duration || 15) * 1000;
            
            contentTimer = setTimeout(() => {
                if (currentPlaylist.items && currentPlaylist.items.length > 1) {
                    currentIndex = (currentIndex + 1) % currentPlaylist.items.length;
                    currentContent = currentPlaylist.items[currentIndex];
                    renderContent(currentContent);
                    scheduleNextContent();
                }
            }, duration);
        }

        // Fetch Schedule and Playlist
        async function fetchSchedule() {
            try {
                showLoading();
                console.log(`[ArtformTV] Fetching schedule for device: ${DEVICE_ID}`);
                
                const response = await fetch(`${BACKEND_URL}/v1/device/schedule?device_id=${DEVICE_ID}`);
                const data = await response.json();

                if (!data.ok || !data.schedules || data.schedules.length === 0) {
                    showError('No active schedule found for this device. Please configure a schedule in the admin dashboard.');
                    return;
                }

                const schedule = data.schedules[0];
                console.log(`[ArtformTV] Active schedule: ${schedule.name || 'unnamed'}`);

                if (!schedule.mediaId) {
                    showError('Schedule has no playlist assigned. Please assign a playlist in the admin dashboard.');
                    return;
                }

                // Fetch Playlist
                const playlistRes = await fetch(`${BACKEND_URL}/v1/media/${schedule.mediaId}`);
                const playlistData = await playlistRes.json();

                if (!playlistData.ok || !playlistData.playlist) {
                    showError('Failed to load playlist');
                    return;
                }

                const playlist = playlistData.playlist;
                console.log(`[ArtformTV] Playlist loaded: ${playlist.name} (${playlist.items?.length || 0} items)`);

                if (!playlist.items || playlist.items.length === 0) {
                    showError('Playlist is empty. Please add content to the playlist.');
                    return;
                }

                // Validate first item has type
                if (!playlist.items[0].type) {
                    showError('Backend error: Playlist items missing content data. Please sync data from admin dashboard.');
                    return;
                }

                // Start playing
                currentPlaylist = playlist;
                currentIndex = 0;
                currentContent = playlist.items[0];
                
                renderContent(currentContent);
                scheduleNextContent();

            } catch (error) {
                console.error('[ArtformTV] Error:', error);
                showError(`Connection error: ${error.message}. Check your network connection and backend URL.`);
            }
        }

        // Start Player
        fetchSchedule();

        // Refresh schedule every 5 minutes
        setInterval(fetchSchedule, 5 * 60 * 1000);
    </script>
</body>
</html>
